{% extends "public/base.html" %}

{% block page-title %}
     <div class="app-title">
         <div>
             <h1><i class="fa fa-gear block-config">数据配置</i></h1>
         </div>
         <ul class="app-breadcrumb breadcrumb">
             <li class="breadcrumb-item"><i class="fa fa-home fa-lg"></i></li>
             <li class="breadcrumb-item"><a href="#">返回</a></li>
         </ul>
     </div>
{% endblock %}

{% block page-content %}
    {% load mytags %}
    <style>
        h5{
            display: inline-block;
            margin-left: 15px;
            }
         hr{
             margin-top: 5px;
             margin-bottom: 5px;
         }
        #create-div{
            margin-bottom: 0;
        }
        .report-data-info{
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .quota-field span, .dimension-field span{
            margin-right: 5px;
            cursor: pointer;
        }
        .content-row .data-title{
            background-color: rgba(29, 93, 104, 0.21);
        }
        .form-control{
            border-radius: 1px;
            font-size: 14px;
            line-height: 1.42857143;
            width: 100%;
            display: block;
            box-shadow: none;
            padding: 6px 12px;

        }

        .quota-field, .dimension-field{
            overflow: auto;
        }
        .table thead th, .table tbody{
            text-align: center;
        }
        .table tbody tr td{
            padding: 1px;
            line-height: 2.428571;

        }

    </style>

    <div class="panel panel-default">

        {# 根据不同的前端数据展示类型, 呈现出不同的form表单布局 #}
        {% for i in block_obj %}
            
            {% if i.block_type == 0 %}

                <form action="" class="form-horizontal">
                    <div class="block_obj" style="display: none">{{ i }}</div>
                    <div class="panel panel-body report-data-info">
                        <div class="content-row">
                            <div class="row data-title">
                                <label class="col-sm-1">图表属性</label>

                                <div class="col-sm-1" style="left: 85%">
                                    <i class="fa fa-bars dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"></i>
                                    <ul class="dropdown-menu" style="min-width: 20px; left: 14px;">
                                        <li><i class="fa fa-chevron-up" onclick="move_up(this)"></i></li>
                                        <li><i class="fa fa-chevron-down" onclick="move_down(this)"></i></li>
                                        <li><i class="fa fa-trash-o" onclick="delete_block(this)"></i></li>
                                    </ul>
                                </div>

                            </div>

                            <hr>

                            <div>

                                <div class="row">
                                    <label class="col-sm-1 control-label">图表标题</label>
                                    <div class="col-sm-3">
                                        <input type="text" class="form-control" name="bid" value="{{ i.bid }}" style="display: none">
                                        <input type="text" class="form-control" name="block_type" value="{{ i.block_type }}" style="display: none">
                                        <input type="text" class="form-control" name="region_id" value="{{ i.region_id }}" style="display: none">
                                        <input type="text" class="form-control " name="block_name" value="{{ i.block_name }}" required>
                                    </div>
                                </div>
                                <hr>
                                <div class="row">
                                    <label class="col-sm-1 control-label">图形类型</label>
                                    <div class="col-sm-3">
                                          <select class="form-control" name="chart_type" chart_type="{{ i.chart_type }}">
                                                <option value="1">折线图</option>
                                                <option value="2">柱形图</option>
                                                <option value="3">雷达图</option>
                                                <option value="4">饼图</option>
                                                <option value="5">漏洞图</option>
                                          </select>
                                      </div>
                                </div>
                                <hr>
                                <div class="row">
                                    <label class="col-sm-1 control-label">数据表名称</label>
                                    <div class="col-sm-3">
                                        <input type="text" class="form-control" name="source_name" value="{{ i.source_name }}" required>
                                    </div>
                                </div>

                                <hr>
                                <div class="row">
                                    <label class="col-sm-1 control-label">报告类型</label>
                                    <div class="col-sm-2">
                                        <select name="report_type" class="form-control" report_type="{{ i.report_type }}">
                                            <option value="0">无数据</option>
                                            <option value="1">日报</option>
                                            <option value="2">周报</option>
                                            <option value="3">月报</option>
                                            <option value="4">年报</option>
                                            <option value="5">实时</option>
                                        </select>
                                    </div>
                                </div>
                                <hr>

                                 <div class="row">
                                    <label class="col-sm-1 control-label">过滤条件</label>
                                    <div class="col-sm-3">
                                        <input type="text" class="form-control" name="source_filter" value="{{ i.source_filter }}" required>
                                    </div>
                                </div>

                                <hr>
                                <div class="form-group row">
                                    <label class="col-sm-1">指标</label>
                                    <div class="col-sm-11 quota-field">

                                    </div>

                                    <label class="col-sm-1">维度</label>
                                    <div class="col-sm-11 dimension-field">

                                    </div>
                                </div>

                                <hr>

                            </div>

                            <div class="ibox-content">
                                <h5>维度配置</h5>
                                <div class="form-group">
                                    <div class="table-responsive">

                                        <table class="table items_table table-bordered">
                                            <thead>
                                                <tr role="row">
                                                    <th>操作</th>
                                                    <th>字段</th>
                                                    <th>名称</th>
                                                    <th>字段类型</th>
                                                    <th>收拢方式</th>
                                                    <th>是否排序</th>
                                                    <th>是否筛选</th>
                                                    <th>是否显示</th>
                                                </tr>
                                            </thead>
                                            <tbody class="dimension-config">
                                                {% for j in field_obj %}
                                                    {% if j.bid_id == i.bid and j.field_type != 0 %}
                                                        <tr>
                                                            <input type="hidden" name="fid" value="{{ j.fid }}">
                                                            <td>
                                                                <span class="label label-danger label-delete-it" style="cursor: pointer;margin-right: 2px;" onclick="delete_block_quota(this)">删除</span>
                                                            </td>
                                                            <td><input class="form-control" name="field_name" type="text" value="{{ j.field_name }}" hidden>{{ j.field_name }}</td>
                                                            <td><input class="form-control" name="field_name_cn" type="text" value="{{ j.field_name_cn }}" required></td>
                                                            <td>
                                                                <select class="form-control" name="field_type" field_type="{{ j.field_type }}">
                                                                    <option value="0">指标</option>
                                                                    <option value="1">维度</option>
                                                                    <option value="2">时间</option>
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <select class="form-control" name="furl_mode" furl_mode="{{ j.furl_mode }}">
                                                                    <option value="0">展开</option>
                                                                    <option value="1">收拢</option>
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <select class="form-control" name="is_sort" is_sort="{{ j.is_sort }}">
                                                                    <option value="0">不排序</option>
                                                                    <option value="1">正序</option>
                                                                    <option value="2">倒序</option>
                                                                </select>
                                                            </td>
                                                             <td>
                                                                <select class="form-control" name="is_filter" is_filter="{{ j.is_filter }}">
                                                                    <option value="0">否</option>
                                                                    <option value="1">是</option>
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <select class="form-control" name="is_show" is_show="{{ j.is_show }}">
                                                                    <option value="0">是</option>
                                                                    <option value="1">否</option>
                                                                </select>
                                                            </td>
                                                        </tr>
                                                    {% endif %}
                                                {% endfor %}
                                            </tbody>
                                        </table>

                                    </div>
                                </div>
                            </div>


                            <div class="ibox-content">
                                    <h5>指标</h5>
                                    <span class="btn btn-sm btn-primary m-t-n-xs add-item" onclick="add_block_quota(this)" style="margin-left: 5px;"><strong>新 增</strong></span>
                                    <div class="form-group">

                                        <div class="table-responsive">
                                        <table class="table items_table table-bordered">
                                            <thead>
                                            <tr>
                                                <th>操作</th>
                                                <th>字段</th>
                                                <th>名称</th>
                                                <th>字段类型</th>
                                                <th>计算方式</th>
                                                <th>公式</th>
                                                <th>是否排序</th>
                                                <th>是否筛选</th>
                                                <th>是否显示</th>
                                            </tr>
                                            </thead>
                                            <tbody class="quota-config">
                                                {% for j in field_obj %}
                                                    {% if j.bid_id == i.bid and j.field_type == 0 %}
                                                        <tr>
                                                            <input type="hidden" name="fid" value="{{ j.fid }}">
                                                            <td>
                                                               <span class="label label-danger label-delete-it" style="cursor: pointer;margin-right: 2px;" onclick="delete_block_quota(this)">删除</span>
                                                            </td>
                                                            <td><input class="form-control" name="field_name" type="text" value="{{ j.field_name }}" hidden>{{ j.field_name }}</td>
                                                            <td><input class="form-control" name="field_name_cn" type="text" value="{{ j.field_name_cn }}" required></td>
                                                            <td>
                                                                <select class="form-control" name="field_type" field_type="{{ j.field_type }}">
                                                                    <option value="0">指标</option>
                                                                    <option value="1">维度</option>
                                                                    <option value="2">时间</option>
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <select class="form-control" name="method" method="{{ j.method }}">
                                                                    <option value="0">sum</option>
                                                                    <option value="1">count</option>
                                                                    <option value="2">min</option>
                                                                    <option value="3">max</option>
                                                                    <option value="4">avg</option>
                                                                </select>
                                                            </td>
                                                            <td><input class="form-control" name="formula" type="text" value="{{ j.formula }}"></td>
                                                            <td>
                                                                <select class="form-control" name="is_sort" is_sort="{{ j.is_sort }}">
                                                                    <option value="0">不排序</option>
                                                                    <option value="1">正序</option>
                                                                    <option value="1">倒序</option>
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <select class="form-control" name="is_filter" is_filter="{{ j.is_filter }}">
                                                                    <option value="0">否</option>
                                                                    <option value="1">是</option>
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <select class="form-control" name="is_show" is_show="{{ j.is_show }}">
                                                                    <option value="0">是</option>
                                                                    <option value="1">否</option>
                                                                </select>
                                                            </td>
                                                        </tr>
                                                    {% endif %}
                                                {% endfor %}
                                            </tbody>
                                        </table>

                                    </div>



                                    </div>

                                </div>

                        </div>
                    </div>
                </form>
            {% elif i.block_type == 1 %}
                <form class="form-horizontal">
                    <div class="panel panel-body report-data-info">
                        <div class="content-row">
                            <div class="row data-title">
                                <label class="col-sm-1">表格属性</label>

                                <div class="col-sm-1" style="left: 85%">
                                    <i class="fa fa-bars dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"></i>
                                    <ul class="dropdown-menu" style="min-width: 20px; left: 14px;">
                                        <li><i class="fa fa-chevron-up" onclick="move_up(this)"></i></li>
                                        <li><i class="fa fa-chevron-down" onclick="move_down(this)"></i></li>
                                        <li><i class="fa fa-trash-o" onclick="delete_block(this)"></i></li>
                                    </ul>
                                </div>
                            </div>
                            <hr>
                            <div>
                                <div class="row">
                                    <label class="col-sm-1 control-label">表格名:</label>
                                    <div class="col-sm-2">
                                        <input type="text" style="display: none" name="bid" value="{{ i.bid }}">
                                        <input type="text"  name="block_type" value="{{ i.block_type }}" style="display: none">
                                        <input type="text"  name="region_id" value="{{ i.region_id }}" style="display: none">
                                        <input type="text" class="form-control" name="block_name" value="{{ i.block_name }}" required>
                                    </div>
                                </div>
                                <hr>

                                <div class="row">
                                    <label class="col-sm-1 control-label">数据表</label>
                                    <div class="col-sm-2">
                                        <input type="text" class="form-control" name="source_name" value="{{ i.source_name }}" required>
                                    </div>
                                </div>

                                <hr>
                                <div class="row">
                                    <label class="col-sm-1 control-label">报告类型</label>
                                    <div class="col-sm-2">
                                        <select name="report_type" class="form-control" report_type="{{ i.report_type }}">
                                            <option value="0">无数据</option>
                                            <option value="1">日报</option>
                                            <option value="2">周报</option>
                                            <option value="3">月报</option>
                                            <option value="4">年报</option>
                                            <option value="5">实时</option>
                                        </select>
                                    </div>
                                </div>

                                <hr>

                                 <div class="row">
                                    <label class="col-sm-1 control-label">过滤条件</label>
                                    <div class="col-sm-3">
                                        <input type="text" class="form-control" name="source_filter" value="{{ i.source_filter }}" required>
                                    </div>
                                </div>

                                <hr>

                                <div class="form-group row">

                                    <label class="col-sm-1">指标</label>
                                    <div class="col-sm-11 quota-field">

                                    </div>
                                    <label class="col-sm-1 control-label">维度</label>
                                    <div class="col-sm-11 dimension-field">
                                    </div>

                                </div>

                                <hr>

                            </div>
                            <div class="ibox-content">
                                <h5>维度配置</h5>
                                <div class="form-group">

                                    <div class="table-responsive">
                                        <table class="table items_table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>操作</th>
                                                    <th>字段</th>
                                                    <th>名称</th>
                                                    <th>指标类型</th>
                                                    <th>收拢方式</th>
                                                    <th>是否排序</th>
                                                    <th>是否筛选</th>
                                                    <th>是否显示</th>
                                                </tr>
                                            </thead>
                                            <tbody class="dimension-config">
                                                {% for j in field_obj %}
                                                    {% if j.bid_id == i.bid and j.field_type != 0 %}
                                                        <tr>
                                                            <input type="hidden" name="fid" value="{{ j.fid }}">
                                                            <td>
                                                               <span class="label label-danger label-delete-it" style="cursor: pointer;margin-right: 2px;" onclick="delete_block_quota(this)">删除</span>
                                                            </td>
                                                            <td><input class="form-control" name="field_name" type="text" value="{{ j.field_name }}" hidden>{{ j.field_name }}</td>
                                                            <td><input class="form-control" name="field_name_cn" type="text" value="{{ j.field_name_cn }}" required></td>
                                                            <td>
                                                                <select class="form-control" name="field_type" field_type="{{ j.field_type }}">
                                                                    <option value="0">指标</option>
                                                                    <option value="1">维度</option>
                                                                    <option value="2">时间</option>
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <select class="form-control" name="furl_mode" furl_mode="{{ j.furl_mode }}">
                                                                    <option value="0">展开</option>
                                                                    <option value="1">收拢</option>
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <select class="form-control" name="is_sort" is_sort="{{ j.is_sort }}">
                                                                    <option value="0">不排序</option>
                                                                    <option value="1">正序</option>
                                                                    <option value="1">倒序</option>
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <select class="form-control" name="is_filter" is_filter="{{ j.is_filter }}">
                                                                    <option value="0">否</option>
                                                                    <option value="1">是</option>
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <select class="form-control" name="is_show" is_show="{{ j.is_show }}">
                                                                    <option value="0">是</option>
                                                                    <option value="1">否</option>
                                                                </select>
                                                            </td>
                                                        </tr>
                                                    {% endif %}
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="ibox-content">

                                <h5>指标</h5>
                                <span class="btn btn-sm btn-primary m-t-n-xs add-item" onclick="add_block_quota(this)" style="margin-left: 5px;"><strong>新 增</strong></span>

                                <div class="form-group">

                                    <div class="table-responsive">

                                        <table class="table table-striped table-bordered items_table">
                                            <thead>
                                                <tr>
                                                    <th>操作</th>
                                                    <th>字段</th>
                                                    <th>名称</th>
                                                    <th>指标类型</th>
                                                    <th>计算方式</th>
                                                    <th>公式</th>
                                                    <th>是否排序</th>
                                                    <th>是否筛选</th>
                                                    <th>是否显示</th>
                                                </tr>
                                            </thead>
                                            <tbody class="quota-config">

                                                {% for j in field_obj %}
                                                    {% if j.bid_id == i.bid and j.field_type == 0 %}
                                                        <tr>
                                                            <input type="hidden" name="fid" value="{{ j.fid }}">
                                                            <td>
                                                               <span class="label label-danger label-delete-it" style="cursor: pointer;margin-right: 2px;" onclick="delete_block_quota(this)">删除</span>
                                                            </td>
                                                            <td><input class="form-control" name="field_name" type="text" value="{{ j.field_name }}" hidden>{{ j.field_name }}</td>
                                                            <td><input class="form-control" name="field_name_cn" type="text" value="{{ j.field_name_cn }}" required></td>
                                                            <td>
                                                                <select class="form-control" name="field_type" field_type="{{ j.field_type }}">
                                                                    <option value="0">指标</option>
                                                                    <option value="1">维度</option>
                                                                    <option value="2">时间</option>
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <select class="form-control" name="method" method="{{ j.method }}">
                                                                    <option value="0">sum</option>
                                                                    <option value="1">count</option>
                                                                    <option value="2">min</option>
                                                                    <option value="3">max</option>
                                                                    <option value="4">avg</option>
                                                                </select>
                                                            </td>
                                                            <td><input class="form-control" name="formula" type="text" value="{{ j.formula }}"></td>
                                                            <td>
                                                                <select class="form-control" name="is_sort" is_sort="{{ j.is_sort }}">
                                                                    <option value="0">不排序</option>
                                                                    <option value="1">正序</option>
                                                                    <option value="1">倒序</option>
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <select class="form-control" name="is_filter" is_filter="{{ j.is_filter }}">
                                                                    <option value="0">否</option>
                                                                    <option value="1">是</option>
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <select class="form-control" name="is_show" is_show="{{ j.is_show }}">
                                                                    <option value="0">是</option>
                                                                    <option value="1">否</option>
                                                                </select>
                                                            </td>
                                                        </tr>
                                                    {% endif %}
                                                {% endfor %}

                                            </tbody>
                                        </table>

                                    </div>

                                </div>

                            </div>
                        </div>
                    </div>
                </form>
            {% elif i.block_type == 2 %}
                <form class="form-horizontal">
                    <div class="panel panel-body report-data-info">
                        <div class="content-row">
                            <div class="row data-title">
                                <label class="col-sm-1">文本配置</label>

                                <div class="col-sm-1" style="left: 85%">
                                    <i class="fa fa-bars dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"></i>
                                    <ul class="dropdown-menu" style="min-width: 20px; left: 14px;">
                                        <li><i class="fa fa-chevron-up" onclick="move_up(this)"></i></li>
                                        <li><i class="fa fa-chevron-down" onclick="move_down(this)"></i></li>
                                        <li><i class="fa fa-trash-o" onclick="delete_block(this)"></i></li>
                                    </ul>
                                </div>
                            </div>
                            <hr>
                            <div>
                                <div class="row">
                                    <label class="col-sm-1 control-label">标题</label>
                                    <div class="col-sm-3">
                                        <input type="text" name="bid" value="{{ i.bid }}" style="display: none">
                                        <input type="text"  name="block_type" value="{{ i.block_type }}" style="display: none">
                                        <input type="text"  name="region_id" value="{{ i.region_id }}" style="display: none">
                                        <input type="text" class="form-control" name="block_name" value="{{ i.block_name }}" required>
                                    </div>
                                </div>
                                <hr>
                                <div class="row">
                                    <label class="col-sm-1 control-label">内容</label>
                                    <div class="col-sm-6">
                                        <textarea class="form-control" rows="3" name="block_content" required>{{ i.block_content }}</textarea>
                                    </div>
                                </div>
                                <hr>
                            </div>
                        </div>
                    </div>
                </form>
            {% elif i.block_type == 3 %}
                <form class="form-horizontal">
                    <div class="panel panel-body report-data-info">
                        <div class="content-row">
                            <div class="row data-title">

                                <label class="col-sm-1">数据块</label>

                                <div class="col-sm-1" style="left: 85%">
                                    <i class="fa fa-bars dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"></i>
                                    <ul class="dropdown-menu" style="min-width: 20px; left: 14px;">
                                        <li><i class="fa fa-chevron-up" onclick="move_up(this)"></i></li>
                                        <li><i class="fa fa-chevron-down" onclick="move_down(this)"></i></li>
                                        <li><i class="fa fa-trash-o" onclick="delete_block(this)"></i></li>
                                    </ul>
                                </div>

                            </div>
                            <hr>
                            <div>
                                <div class="row">
                                    <label class="col-sm-1 control-label">标题</label>
                                    <div class="col-sm-2">
                                        <input type="text" name="bid" value="{{ i.bid }}" style="display: none">
                                        <input type="text" name="block_type" value="{{ i.block_type }}" style="display: none">
                                        <input type="text" name="region_id" value="{{ i.region_id }}" style="display: none">
                                        <input type="text" class="form-control" name="block_name" value="{{ i.block_name }}" required>
                                    </div>
                                </div>
                                <hr>
                                <div class="row">
                                    <label class="col-sm-1 control-label">数据表</label>
                                    <div class="col-sm-2">
                                        <input type="text" class="form-control" name="source_name" value="{{ i.source_name }}" required>
                                    </div>
                                </div>
                                <hr>

                                <div class="row">
                                    <label class="col-sm-1 control-label">报告类型</label>
                                    <div class="col-sm-2">
                                        <select name="report_type" class="form-control" report_type="{{ i.report_type }}">
                                            <option value="0">无数据</option>
                                            <option value="1">日报</option>
                                            <option value="2">周报</option>
                                            <option value="3">月报</option>
                                            <option value="4">年报</option>
                                            <option value="5">实时</option>
                                        </select>
                                    </div>
                                </div>
                                <hr>

                                 <div class="row">
                                    <label class="col-sm-1 control-label">过滤条件</label>
                                    <div class="col-sm-3">
                                        <input type="text" class="form-control" name="source_filter" value="{{ i.source_filter }}" required>
                                    </div>
                                </div>

                                <hr>
                                <div class="form-group row">
                                    <label class="col-sm-1">指标</label>
                                    <div class="col-sm-11 quota-field">

                                    </div>
                                    <label class="col-sm-1 control-label">维度</label>
                                    <div class="col-sm-11 dimension-field">

                                    </div>
                                </div>
                                <hr>
                            </div>
                            <div class="ibox-content">
                                <h5>维度配置</h5>
                                <div class="form-group">
                                    <div class="table-responsive">

                                        <table class="table items_table">
                                            <thead>
                                            <tr>
                                                <th>操作</th>
                                                <th>字段</th>
                                                <th>名称</th>
                                                <th>指标类型</th>
                                                <th>收拢方式</th>
                                                <th>是否排序</th>
                                                <th>是否筛选</th>
                                                <th>是否显示</th>
                                            </tr>
                                            </thead>
                                            <tbody class="dimension-config">
                                                {% for j in field_obj %}
                                                    {% if j.bid_id == i.bid and j.field_type != 0  %}
                                                        <tr>
                                                            <input type="hidden" name="fid" value="{{ j.fid }}">
                                                            <td>
                                                               <span class="label label-danger label-delete-it" style="cursor: pointer;margin-right: 2px;" onclick="delete_block_quota(this)">删除</span>
                                                            </td>
                                                            <td><input class="form-control" name="field_name" type="text" value="{{ j.field_name }}" hidden>{{ j.field_name }}</td>
                                                            <td><input class="form-control" name="field_name_cn" type="text" value="{{ j.field_name_cn }}" required></td>
                                                            <td>
                                                                <select class="form-control" name="field_type" field_type="{{ j.field_type }}">
                                                                    <option value="0">指标</option>
                                                                    <option value="1">维度</option>
                                                                    <option value="2">时间</option>
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <select class="form-control" name="furl_mode" furl_mode="{{ j.furl_mode }}">
                                                                    <option value="0">展开</option>
                                                                    <option value="1">收拢</option>
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <select class="form-control" name="is_sort" is_sort="{{ j.is_sort }}">
                                                                    <option value="0">不排序</option>
                                                                    <option value="1">正序</option>
                                                                    <option value="2">倒序</option>
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <select class="form-control" name="is_filter" is_filter="{{ j.is_filter }}">
                                                                    <option value="0">否</option>
                                                                    <option value="1">是</option>
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <select class="form-control" name="is_show" is_show="{{ j.is_show }}">
                                                                    <option value="0">是</option>
                                                                    <option value="1">否</option>
                                                                </select>
                                                            </td>
                                                        </tr>
                                                    {% endif %}
                                                {% endfor %}
                                            </tbody>
                                        </table>

                                    </div>
                                </div>
                            </div>
                            <div class="ibox-content">

                                <h5>指标</h5>
                                <span class="btn btn-sm btn-primary m-t-n-xs add-item" onclick="add_block_quota(this)" style="margin-left: 5px;"><strong>新 增</strong></span>
                                <div class="form-group">

                                <div class="table-responsive">
                                    <table class="table table-striped table-bordered items_table">
                                        <thead>
                                            <tr>
                                                <th>操作</th>
                                                <th>字段</th>
                                                <th>名称</th>
                                                <th>字段类型</th>
                                                <th>计算方式</th>
                                                <th>公式</th>
                                                <th>是否排序</th>
                                                <th>是否筛选</th>
                                                <th>是否显示</th>
                                            </tr>
                                        </thead>
                                        <tbody class="quota-config">

                                            {% for j in field_obj %}
                                                {% if j.bid_id == i.bid and j.field_type == 0 %}

                                                    <tr>
                                                        <input type="hidden" name="fid" value="{{ j.fid }}">
                                                        <td>
                                                           <span class="label label-danger label-delete-it" style="cursor: pointer;margin-right: 2px;" onclick="delete_block_quota(this)">删除</span>
                                                        </td>
                                                        <td><input class="form-control" name="field_name" type="text" value="{{ j.field_name }}" hidden>{{ j.field_name }}</td>
                                                        <td><input class="form-control" name="field_name_cn" type="text" value="{{ j.field_name_cn }}" required></td>
                                                        <td>
                                                            <select class="form-control" name="field_type" field_type="{{ j.field_type }}">
                                                                <option value="0">指标</option>
                                                                <option value="1">维度</option>
                                                                <option value="2">时间</option>
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <select class="form-control" name="method" method="{{ j.method }}">
                                                                <option value="0">sum</option>
                                                                <option value="1">count</option>
                                                                <option value="2">min</option>
                                                                <option value="3">max</option>
                                                                <option value="4">avg</option>
                                                            </select>
                                                        </td>
                                                        <td><input class="form-control" name="formula" type="text" value="{{ j.formula }}"></td>
                                                        <td>
                                                            <select class="form-control" name="is_sort" is_sort="{{ j.is_sort }}">
                                                                <option value="0">不排序</option>
                                                                <option value="1">正序</option>
                                                                <option value="1">倒序</option>
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <select class="form-control" name="is_filter" is_filter="{{ j.is_filter }}">
                                                                <option value="0">否</option>
                                                                <option value="1">是</option>
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <select class="form-control" name="is_show" is_show="{{ j.is_show }}">
                                                                <option value="0">是</option>
                                                                <option value="1">否</option>
                                                            </select>
                                                        </td>
                                                    </tr>

                                                {% endif %}
                                            {% endfor %}

                                        </tbody>
                                    </table>
                                </div>

                            </div>

                            </div>

                        </div>
                    </div>
                </form>
            {% endif%}

        {% endfor %}
        
        
        <div id="create-div">
            <button type="button" class="btn btn-info" id="data-submit" style="float: right">下一步</button>
            <i class="btn btn-success increase_index" style="float: right; margin-right: 20px" data-toggle="modal" data-target="#myModal" >图表新增</i>
        </div>
    
    </div>

    {# 模态对话框, 新增form表单时弹出 #}
    <div class="modal fade" tabindex="-1" role="dialog" id="myModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">类型选择</h4>
                </div>
                <div class="modal-body">
                    <select name="block_id" vid="vid" class="form-control">
                         <option value="0">图表</option>
                         <option value="1">表格</option>
                         <option value="2">文本</option>
                         <option value="3">数据</option>
                     </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary add_item" data-dismiss="modal" >确定</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../../static/public/plugins/common/jquery.min.js"></script>

    <script>

        $(function () {
            add_report_config_html();
            submit_report_config_data();
            judge_filed_type();
            init_dimension_and_quota();
            init_select_value();
        });

        // 添加点击时添加form表单,用于配置报表数据
        function add_report_config_html() {
            $('.add_item').click(function () {
                var block_value = $(this).parent().prev().find('select').val();
                report_config_ele(block_value)
            })
        }

        // 报表form表单的定义
        function report_config_ele(block_value, region_id) {
            var block_data = {};
            block_data[0] =  "<form>"+
                    "<div class=\"panel panel-body report-data-info\">"+
                          "<div class=\"content-row\">"+
                              "<div class=\"row data-title\">"+

                                 "<label class=\"col-sm-1\">图表属性</label>"+

                                  "<div class=\"col-sm-1\" style=\"left: 85%\">"+
                                       "<i class=\"fa fa-bars dropdown-toggle\" data-toggle=\"dropdown\" role=\"button\" aria-haspopup=\"true\" aria-expanded=\"false\"></i>"+
                                        "<ul class=\"dropdown-menu\" style=\"min-width: 20px; left: 14px;\">"+
                                            "<li><i class=\"fa fa-chevron-up\" onclick=\"move_up(this)\"></i></li>"+
                                            "<li><i class=\"fa fa-chevron-down\" onclick=\"move_down(this)\"></i></li>"+
                                            "<li><i class=\"fa fa-trash-o\" onclick=\"delete_block(this)\"></i></li>"+
                                        "</ul>"+
                                    "</div>"+

                              "</div>"+
                              "<hr>"+
                              "<div>"+

                                  "<div class=\"row\">"+
                                      "<label class=\"col-sm-1 control-label\">标题</label>"+
                                      "<div class=\"col-sm-2\">"+
                                          "<input type=\"text\" class=\"form-control\" name=\"block_type\" value='"+block_value+"'style=\"display: none\">"+
                                          "<input type=\"text\" class=\"form-control block_region\" name=\"region_id\" value='"+region_id+"' style=\"display: none\">"+
                                          "<input type=\"text\" class=\"form-control \" name=\"block_name\" required>"+
                                      "</div>"+
                                  "</div>"+
                                  "<hr>"+
                                  "<div class=\"row\">"+
                                      "<label class=\"col-sm-1 control-label\">图形类型</label>"+
                                      "<div class=\"col-sm-2\">"+
                                          "<select class=\"form-control\" name=\"chart_type\">"+
                                                "<option value=\"1\">折线图</option>"+
                                                "<option value=\"2\">柱形图</option>"+
                                                "<option value=\"3\">雷达图</option>"+
                                                "<option value=\"4\">饼图</option>"+
                                                "<option value=\"5\">漏洞图</option>"+
                                          "</select>"+
                                      "</div>"+

                                  "</div>"+
                                  "<hr>"+
                                  "<div class=\"row\">"+
                                   "<label class=\"col-sm-1 control-label\">数据表名称</label>"+
                                   "<div class=\"col-sm-2\">"+
                                       "<input type=\"text\" class=\"form-control\" name=\"source_name\" required>"+
                                   "</div>"+
                                  "</div>"+
                                  "<hr>"+

                                 "<div class=\"row\">"+
                                    "<label class=\"col-sm-1 control-label\">报告类型</label>"+
                                    "<div class=\"col-sm-2\">"+
                                        "<select name=\"report_type\" class=\"form-control\">"+
                                            "<option value=\"0\">无数据</option>"+
                                            "<option value=\"1\">日报</option>"+
                                            "<option value=\"2\">周报</option>"+
                                            "<option value=\"3\">月报</option>"+
                                            "<option value=\"4\">年报</option>"+
                                            "<option value=\"5\">实时</option>"+
                                        "</select>"+
                                   "</div>"+
                                "</div>"+
                                    "<hr>"+
                                     "<div class=\"row\">"+
                                    "<label class=\"col-sm-1 control-label\">过滤条件</label>"+
                                    "<div class=\"col-sm-3\">"+
                                        "<input type=\"text\" class=\"form-control\" name=\"source_filter\" value=\"\">"+
                                    "</div>"+
                                "</div>"+
                                    "<hr>"+
                                    "<div class=\"form-group row\">"+
                                   "<label class=\"col-sm-1\">指标</label>"+
                                   "<div class=\"col-sm-11 quota-field\">"+

                                   "</div>"+
                                      "<label class=\"col-sm-1 control-label\">维度</label>"+
                                   "<div class=\"col-sm-11 dimension-field\">"+

                                   "</div>"+

                                  "</div>"+



                                  "<hr>"+



                            "</div>"+





                            "<div class=\"ibox-content\">"+

                                "<h5>维度配置</h5>"+
                                "<div class=\"form-group\">"+

                                "<div class=\"table-responsive\">"+
                                    "<table class=\"table table-striped items_table\">"+
                                        "<thead>"+
                                        "<tr>"+
                                            "<th>操作</th>"+
                                            "<th>字段</th>"+
                                            "<th>名称</th>"+
                                            "<th>字段类型</th>"+
                                            "<th>收拢方式</th>"+
                                            "<th>是否排序</th>"+
                                            "<th>是否筛选</th>"+
                                            "<th>是否显示</th>"+
                                        "</tr>"+
                                        "</thead>"+
                                        "<tbody class=\"dimension-config\">"+

                                        "</tbody>"+
                                    "</table>"+
                                "</div>"+

                                "</div>"+
                            "</div>"+




                            "<div class=\"ibox-content\">"+

                                "<h5>指标</h5>"+
                                "<span class=\"btn btn-sm btn-primary m-t-n-xs add-item\" onclick=\"add_block_quota(this)\" style=\"margin-left: 5px;\"><strong>新 增</strong></span>"+

                                "<div class=\"form-group\">"+

                                "<div class=\"table-responsive\">"+
                                    "<table class=\"table table-striped items_table\">"+
                                        "<thead>"+
                                        "<tr>"+
                                            "<th>操作</th>"+
                                            "<th>字段</th>"+
                                            "<th>名称</th>"+
                                            "<th>公式</th>"+
                                            "<th>字段类型</th>"+
                                            "<th>计算方式</th>"+
                                            "<th>是否排序</th>"+
                                            "<th>是否筛选</th>"+
                                            "<th>是否显示</th>"+
                                        "</tr>"+
                                        "</thead>"+
                                        "<tbody class=\"quota-config\">"+

                                        "</tbody>"+
                                    "</table>"+
                                "</div>"+

                                "</div>"+
                            "</div>"+

                              "</div>"+
                          "</div>"+
                      "</div>"+
                "</form>";

            block_data[1] =  "<form>"+
                    "<div class=\"panel panel-body report-data-info\">"+
                        "<div class=\"content-row\">"+
                            "<div class=\"row data-title\">"+

                                 "<label class=\"col-sm-1\">表格属性</label>"+

                                  "<div class=\"col-sm-1\" style=\"left: 85%\">"+
                                       "<i class=\"fa fa-bars dropdown-toggle\" data-toggle=\"dropdown\" role=\"button\" aria-haspopup=\"true\" aria-expanded=\"false\"></i>"+
                                        "<ul class=\"dropdown-menu\" style=\"min-width: 20px; left: 14px;\">"+
                                             "<li><i class=\"fa fa-chevron-up\" onclick=\"move_up(this)\"></i></li>"+
                                            "<li><i class=\"fa fa-chevron-down\" onclick=\"move_down(this)\"></i></li>"+
                                            "<li><i class=\"fa fa-trash-o\" onclick=\"delete_block(this)\"></i></li>"+
                                        "</ul>"+
                                    "</div>"+

                            "</div>"+
                            "<hr>"+
                            "<div>"+

                                "<div class=\"row\">"+
                                    "<label class=\"col-sm-1 control-label\">表格名:</label>"+
                                    "<div class=\"col-sm-2\">"+
                                        "<input type=\"text\" class=\"form-control block_region\" name=\"block_type\" value='"+ block_value +"'style=\"display: none\">"+
                                         "<input type=\"text\" class=\"form-control block_region\" name=\"region_id\" value='"+region_id+"' style=\"display: none\">"+
                                        "<input type=\"text\" class=\"form-control\" name=\"block_name\" required>"+
                                    "</div>"+
                                "</div>"+
                                "<hr>"+
                                "<div class=\"row\">"+
                                 "<label class=\"col-sm-1 control-label\">数据表</label>"+
                                 "<div class=\"col-sm-2\">"+
                                     "<input type=\"text\" class=\"form-control\" name=\"source_name\" required>"+
                                 "</div>"+
                                "</div>"+

                                      "<hr>"+


                                    "<div class=\"row\">"+
                                    "<label class=\"col-sm-1 control-label\">报告类型</label>"+
                                    "<div class=\"col-sm-2\">"+
                                        "<select name=\"report_type\" class=\"form-control\">"+
                                            "<option value=\"0\">无数据</option>"+
                                            "<option value=\"1\">日报</option>"+
                                            "<option value=\"2\">周报</option>"+
                                            "<option value=\"3\">月报</option>"+
                                            "<option value=\"4\">年报</option>"+
                                            "<option value=\"5\">实时</option>"+
                                        "</select>"+
                                   "</div>"+
                                "</div>"+
                                    "<hr>"+

                                    "<div class=\"row\">"+
                                    "<label class=\"col-sm-1 control-label\">过滤条件</label>"+
                                    "<div class=\"col-sm-3\">"+
                                        "<input type=\"text\" class=\"form-control\" name=\"source_filter\" value=\"\">"+
                                    "</div>"+
                                "</div>"+
                                    "<hr>"+

                                    "<div class=\"form-group row\">"+
                                   "<label class=\"col-sm-1\">指标</label>"+
                                   "<div class=\"col-sm-11 quota-field\">"+

                                   "</div>"+
                                      "<label class=\"col-sm-1 control-label\">维度</label>"+
                                   "<div class=\"col-sm-11 dimension-field\">"+

                                   "</div>"+

                                  "</div>"+

                                  "<hr>"+





                            "</div>"+


                            "<div class=\"ibox-content\">"+

                                "<h5>维度配置</h5>"+
                                "<div class=\"form-group\">"+

                                "<div class=\"table-responsive\">"+
                                    "<table class=\"table table-striped items_table\">"+
                                        "<thead>"+
                                        "<tr>"+
                                            "<th>操作</th>"+
                                            "<th>字段</th>"+
                                            "<th>名称</th>"+
                                            "<th>字段类型</th>"+
                                            "<th>收拢方式</th>"+
                                            "<th>是否排序</th>"+
                                            "<th>是否筛选</th>"+
                                            "<th>是否显示</th>"+
                                        "</tr>"+
                                        "</thead>"+
                                        "<tbody class=\"dimension-config\">"+

                                        "</tbody>"+
                                    "</table>"+
                                "</div>"+

                                "</div>"+
                            "</div>"+


                            "<div class=\"ibox-content\">"+
                                "<h5>指标</h5>"+
                                "<span class=\"btn btn-sm btn-primary m-t-n-xs add-item\" onclick=\"add_block_quota(this)\" style=\"margin-left: 5px;\"><strong>新 增</strong></span>"+
                                "<div class=\"form-group\">"+

                                "<div class=\"table-responsive\">"+
                                    "<table class=\"table table-striped items_table\">"+
                                        "<thead>"+
                                        "<tr>"+
                                            "<th>操作</th>"+
                                            "<th>字段</th>"+
                                            "<th>名称</th>"+
                                            "<th>字段类型</th>"+
                                            "<th>计算方式</th>"+
                                            "<th>公式</th>"+
                                            "<th>是否排序</th>"+
                                            "<th>是否筛选</th>"+
                                            "<th>是否显示</th>"+
                                        "</tr>"+
                                        "</thead>"+
                                        "<tbody class=\"quota-config\">"+

                                        "</tbody>"+
                                    "</table>"+
                                "</div>"+

                            "</div>"+


                            "</div>"+
                        "</div>"+
                    "</div>"+
                    "<hr>"+
                "</form>";
            block_data[2] =  "<form>"+
                    "<div class=\"panel panel-body report-data-info\">"+
                        "<div class=\"content-row\">"+
                            "<div class=\"row data-title\">"+

                                 "<label class=\"col-sm-1\">文本属性</label>"+

                                  "<div class=\"col-sm-1\" style=\"left: 85%\">"+
                                       "<i class=\"fa fa-bars dropdown-toggle\" data-toggle=\"dropdown\" role=\"button\" aria-haspopup=\"true\" aria-expanded=\"false\"></i>"+
                                        "<ul class=\"dropdown-menu\" style=\"min-width: 20px; left: 14px;\">"+
                                             "<li><i class=\"fa fa-chevron-up\" onclick=\"move_up(this)\"></i></li>"+
                                            "<li><i class=\"fa fa-chevron-down\" onclick=\"move_down(this)\"></i></li>"+
                                            "<li><i class=\"fa fa-trash-o\" onclick=\"delete_block(this)\"></i></li>"+
                                        "</ul>"+
                                    "</div>"+

                            "</div>"+
                            "<hr>"+
                            "<div>"+
                                "<div class=\"row\">"+
                                 "<label class=\"col-sm-1 control-label\">标题</label>"+
                                 "<div class=\"col-sm-3\">"+
                                    "<input type=\"text\" class=\"form-control block_region\" name=\"block_type\" value='"+ block_value +"'style=\"display: none\">"+
                                    "<input type=\"text\" class=\"form-control block_region\" name=\"region_id\" value='"+region_id+"' style=\"display: none\">"+
                                    "<input type=\"text\" class=\"form-control\" name=\"block_name\" required>"+
                                 "</div>"+
                                "</div>"+
                                "<hr>"+
                                "<div class=\"row\">"+
                                    "<label class=\"col-sm-1 control-label\">内容</label>"+
                                 "<div class=\"col-sm-6\">"+
                                     "<textarea class=\"form-control\" rows=\"3\" name=\"block_content\" required></textarea>"+
                                 "</div>"+
                                "</div>"+

                            "</div>"+
                        "</div>"+
                    "</div>"+
                "</form>";
            block_data[3] =  "<form>"+
                    "<div class=\"panel panel-body report-data-info\">"+
                        "<div class=\"content-row\">"+
                            "<div class=\"row data-title\">"+

                                 "<label class=\"col-sm-1\">数据块属性</label>"+

                                  "<div class=\"col-sm-1\" style=\"left: 85%\">"+
                                       "<i class=\"fa fa-bars dropdown-toggle\" data-toggle=\"dropdown\" role=\"button\" aria-haspopup=\"true\" aria-expanded=\"false\"></i>"+
                                        "<ul class=\"dropdown-menu\" style=\"min-width: 20px; left: 14px;\">"+
                                             "<li><i class=\"fa fa-chevron-up\" onclick=\"move_up(this)\"></i></li>"+
                                            "<li><i class=\"fa fa-chevron-down\" onclick=\"move_down(this)\"></i></li>"+
                                            "<li><i class=\"fa fa-trash-o\" onclick=\"delete_block(this)\"></i></li>"+
                                        "</ul>"+
                                    "</div>"+

                            "</div>"+
                            "<hr>"+
                            "<div>"+
                                "<div class=\"row\">"+
                                 "<label class=\"col-sm-1 control-label\">标题</label>"+
                                 "<div class=\"col-sm-2\">"+
                                    "<input type=\"text\" class=\"form-control block_region\" name=\"block_type\" value='"+ block_value +"'style=\"display: none\">"+
                                     "<input type=\"text\" class=\"form-control block_region\" name=\"region_id\" value='"+region_id+"' style=\"display: none\">"+
                                     "<input type=\"text\" class=\"form-control\" name=\"block_name\" required>"+
                                 "</div>"+
                                "</div>"+

                                "<hr>"+
                                "<div class=\"row\">"+
                                 "<label class=\"col-sm-1 control-label\">数据表</label>"+
                                 "<div class=\"col-sm-2\">"+
                                     "<input type=\"text\" class=\"form-control\" name=\"source_name\" required>"+
                                 "</div>"+
                                "</div>"+
                                "<hr>"+

                                "<div class=\"row\">"+
                                    "<label class=\"col-sm-1 control-label\">报告类型</label>"+
                                    "<div class=\"col-sm-2\">"+
                                        "<select name=\"report_type\" class=\"form-control\">"+
                                            "<option value=\"0\">无数据</option>"+
                                            "<option value=\"1\">日报</option>"+
                                            "<option value=\"2\">周报</option>"+
                                            "<option value=\"3\">月报</option>"+
                                            "<option value=\"4\">年报</option>"+
                                            "<option value=\"5\">实时</option>"+
                                        "</select>"+
                                   "</div>"+
                                "</div>"+
                                    "<hr>"+

                                "<div class=\"row\">"+
                                    "<label class=\"col-sm-1 control-label\">过滤条件</label>"+
                                    "<div class=\"col-sm-3\">"+
                                        "<input type=\"text\" class=\"form-control\" name=\"source_filter\" value=\"\">"+
                                    "</div>"+
                                "</div>"+
                                    "<hr>"+

                                    "<div class=\"form-group row\">"+
                                   "<label class=\"col-sm-1\">指标</label>"+
                                   "<div class=\"col-sm-11 quota-field\">"+
                                        
                                   "</div>"+
                                      "<label class=\"col-sm-1 control-label\">维度</label>"+
                                   "<div class=\"col-sm-11 dimension-field\">"+

                                   "</div>"+

                                  "</div>"+


                                  "<hr>"+


                            "</div>"+


                                "<div class=\"ibox-content\">"+

                                "<h5>维度配置</h5>"+
                                "<div class=\"form-group\">"+

                                "<div class=\"table-responsive\">"+
                                    "<table class=\"table table-striped items_table\">"+
                                        "<thead>"+
                                        "<tr>"+
                                            "<th>操作</th>"+
                                            "<th>字段</th>"+
                                            "<th>名称</th>"+
                                            "<th>字段类型</th>"+
                                            "<th>收拢方式</th>"+
                                            "<th>是否排序</th>"+
                                            "<th>是否筛选</th>"+
                                            "<th>是否显示</th>"+
                                        "</tr>"+
                                        "</thead>"+
                                        "<tbody class=\"dimension-config\">"+

                                        "</tbody>"+
                                    "</table>"+
                                "</div>"+

                                "</div>"+
                            "</div>"+


                            "<div class=\"ibox-content\">"+
                                  "<h5>指标</h5>"+
                                "<span class=\"btn btn-sm btn-primary m-t-n-xs add-item\" onclick=\"add_block_quota(this)\" style=\"margin-left: 5px;\"><strong>新 增</strong></span>"+
                                "<div class=\"form-group\">"+

                                "<div class=\"table-responsive\">"+
                                    "<table class=\"table table-striped items_table\">"+
                                        "<thead>"+
                                        "<tr>"+
                                            "<th>操作</th>"+
                                            "<th>字段</th>"+
                                            "<th>名称</th>"+
                                            "<th>字段类型</th>"+
                                            "<th>计算方式</th>"+
                                            "<th>公式</th>"+
                                            "<th>是否排序</th>"+
                                            "<th>是否筛选</th>"+
                                            "<th>是否显示</th>"+
                                        "</tr>"+
                                        "</thead>"+
                                        "<tbody class=\"quota-config\">"+

                                        "</tbody>"+
                                    "</table>"+
                                "</div>"+

                            "</div>"+



                            "</div>"+
                        "</div>"+
                    "</div>"+

                "</form>";

            $("#create-div").before(block_data[block_value]);
            judge_filed_type();
        }

        // 块指标添加, 点击时触发
        function add_block_quota(th) {
            // 定义添加指标时的html
            var html = "<tr class=\"items_tr\">"+
                        "<input type=\"hidden\" name=\"fid\" value=\"\">"+
                        "<td>"+
                            "<span class=\"label label-danger label-delete-it\" style=\"cursor: pointer;margin-right: 2px;\" onclick=\"delete_block_quota(this)\">删除</span>"+
                        "</td>"+
                        "<td><input class=\"form-control\" name=\"field_name\" type=\"text\" required></td>"+
                        "<td><input class=\"form-control\" name=\"field_name_cn\" type=\"text\" required></td>"+
                        "<td>"+
                            "<select class=\"form-control\" name=\"field_type\">"+
                                "<option value=\"0\">指标</option>"+
                                "<option value=\"1\">维度</option>"+
                                "<option value=\"2\">时间</option>"+
                            "</select>"+
                        "</td>"+

                        "<td>"+
                            "<select class=\"form-control\" name=\"method\">"+
                                "<option value=\"0\" selected=\"\">sum</option>"+
                                "<option value=\"1\">count</option>"+
                                "<option value=\"2\">min</option>"+
                                "<option value=\"3\">max</option>"+
                                "<option value=\"4\">avg</option>"+
                            "</select>"+
                        "</td>"+
                        "<td><input class=\"form-control\" name=\"formula\" type=\"text\"></td>"+

                        "<td>"+
                            "<select class=\"form-control\" name=\"is_sort\">"+
                            "<option value=\"0\">不排序</option>"+
                            "<option value=\"1\">正序</option>"+
                            "<option value=\"2\">倒序</option>"+
                            "</select>"+
                        "</td>"+

                        "<td>"+
                            "<select class=\"form-control\" name=\"is_filter\">"+
                            "<option value=\"0\">否</option>"+
                            "<option value=\"1\">是</option>"+
                            "</select>"+
                        "</td>"+

                        "<td>"+
                            "<select class=\"form-control\" name=\"is_show\" >"+
                                "<option value=\"0\">是</option>"+
                                "<option value=\"1\">否</option>"+
                            "</select>"+
                        "</td>"+
                    "</tr>";
            $(th).parent().find('tbody').append(html);

        }

        // 块指标删除, 点击时触发
        function delete_block_quota(th) {
            var fid = $(th).parent().prev().val();
            if(fid === ""){
                $(th).parents('tr').remove();
                return
            }
            // 删除指标, 根据指标id进行删除
            $.ajax({
                type: "DELETE",
                url: "/visual/report_block_config",
                data: {'fid': fid},
                dataType: "JSON",
                success: function (args) {
                    if(args['code']===0){
                        $(th).parents('tr').remove();
                        window.location.reload()
                    }else {
                        alert('失败')
                    }
                }
            });
        }

        // 填写数据表名称后触发, 生成维度和指标的值
        function judge_filed_type() {
            $("[name=source_name]").on('change', function () {
                var this_ele = $(this);
                var data_source_info = $(this).val();
                var table_name = data_source_info.split('.')[1];
                $.ajax({
                    type: "PUT",
                    url: "/visual/report_block_config",
                    data: {"table_name": table_name},
                    dataType: "JSON",
                    success: function (res) {
                        if(res['code']===0){
                            var html;
                            var tbody_ele = this_ele.parents(".content-row").children().find('tbody');
                            var dimension_ele = this_ele.parents(".content-row").children().find('.dimension-field');
                            var quota_ele = this_ele.parents(".content-row").children().find('.quota-field');
                            tbody_ele.children().remove();
                            dimension_ele.children().remove();
                            quota_ele.children().remove();
                            $.each(JSON.parse(res['data']), function (key, value) {

                                if (value==="dimension"){
                                    html = "<span class=\"label label-primary\" draggable=\"true\" ondblclick="+"dimension_and_quota_ondbclick(this)"+">"+key+"</span>";
                                    dimension_ele.append(html)
                                }else {
                                    html = "<span class=\"label label-primary\" draggable=\"true\" ondblclick="+"dimension_and_quota_ondbclick(this)"+">"+key+"</span>";
                                    quota_ele.append(html)
                                }
                            });
                        }else {
                            alert("请提供正确的数据源！")
                        }
                    }
                })

            })
        }

        // 可视化数据报表配置的数据提交保存
        function submit_report_config_data() {
            $('#data-submit').click(function () {

                // 初始化一个form的列表
                var all_report_block_config_form=[];

                // 赋值region_id
                $.each($("[name=region_id]"), function (i, x) {
                    $(x).val(i)
                });

                // 获取所有form表单的数据并以key-value的形式进行保存
                $.each($('form'), function (i,x) {
                    var single_form_ele = {};
                    var single_form = $(x).serializeArray();
                    single_form_ele['vid']=get_url_param('vid');
                    $.each(single_form, function () {

                        // 如果是指标值将指标对应的值用"-"进行拼接
                        if(this.name in single_form_ele){
                            single_form_ele[this.name]= single_form_ele[this.name]+ "-" + this.value;
                        }else {
                            single_form_ele[this.name] = this.value
                        }
                    });
                    all_report_block_config_form.push(JSON.stringify(single_form_ele))
                });
                // 将这些进行更新后新增图表的数据提交到后台进行更改或添加
                $.ajax({
                    type: "POST",
                    url: "/visual/report_block_config/",
                    data: {'data': JSON.stringify(all_report_block_config_form)},
                    dataType: "JSON",
                    success: function (arg) {
                        console.log(arg)
                    }
                })

            })
        }

        // 根据参数名获取url中的参数
        function get_url_param(name) {
            var reg = new RegExp("(^|&)"+name+"=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if(r !== null){
                return unescape(r[2])
                }
            }

        // 指标和维度配置时触发
        function dimension_and_quota_ondbclick(th) {
            var field_name = $(th).text();
            var html1 = "<tr class=\"items_tr\">"+
                    "<input type=\"hidden\" name=\"fid\" value=\"\">"+
                    "<td>"+
                        "<span class=\"label label-danger label-delete-it\" style=\"cursor: pointer;margin-right: 2px;\" onclick=\"delete_block_quota(this)\">删除</span>"+
                    "</td>"+
                    "<td><input class=\"form-control\" name=\"field_name\" type=\"text\" value='" +field_name+ "' hidden>"+field_name+"</td>"+
                    "<td><input class=\"form-control\" name=\"field_name_cn\" type=\"text\" value=\"\"></td>"+
                    "<td>"+
                        "<select class=\"form-control\" name=\"field_type\">"+
                            "<option value=\"0\">指标</option>"+
                            "<option value=\"1\">维度</option>"+
                            "<option value=\"2\">时间</option>"+
                        "</select>"+
                    "</td>"+

                    "<td>"+
                        "<select class=\"form-control\" name=\"method\">"+
                            "<option value=\"0\" selected=\"\">sum</option>"+
                            "<option value=\"1\">count</option>"+
                            "<option value=\"2\">min</option>"+
                            "<option value=\"3\">max</option>"+
                            "<option value=\"4\">avg</option>"+
                        "</select>"+
                    "</td>"+
                    "<td><input class=\"form-control w100\" name=\"formula\" type=\"text\" value=\"\"></td>"+
                    "<td>"+
                            "<select class=\"form-control\" name=\"is_sort\">"+
                            "<option value=\"0\">不排序</option>"+
                            "<option value=\"1\">正序</option>"+
                            "<option value=\"2\">倒序</option>"+
                        "</select>"+
                    "</td>"+

                    "<td>"+
                        "<select class=\"form-control\" name=\"is_filter\">"+
                        "<option value=\"0\">否</option>"+
                        "<option value=\"1\">是</option>"+
                        "</select>"+
                    "</td>"+
                "</tr>";

            var html2 = "<tr class=\"items_tr\">"+
                    "<input type=\"hidden\" name=\"fid\" value=\"\">"+
                    "<td>"+
                        "<span class=\"label label-danger label-delete-it\" style=\"cursor: pointer;margin-right: 2px;\" onclick=\"delete_block_quota(this)\">删除</span>"+
                    "</td>"+
                    "<td><input class=\"form-control\" name=\"field_name\" type=\"text\" value='" +field_name+ "' hidden>"+field_name+"</td>"+
                    "<td><input class=\"form-control\" name=\"field_name_cn\" type=\"text\" value=\"\"></td>"+
                    "<td>"+
                        "<select class=\"form-control\" name=\"field_type\">"+
                            "<option value=\"0\">指标</option>"+
                            "<option value=\"1\">维度</option>"+
                            "<option value=\"2\">时间</option>"+
                        "</select>"+
                    "</td>"+
                     "<td>"+
                         "<select class=\"form-control\" name=\"furl_mode\">"+
                             "<option value=\"0\">展开</option>"+
                             "<option value=\"1\">收拢</option>"+
                         "</select>"+
                     "</td>"+

                    "<td>"+
                            "<select class=\"form-control\" name=\"is_sort\">"+
                            "<option value=\"0\">不排序</option>"+
                            "<option value=\"1\">正序</option>"+
                            "<option value=\"2\">倒序</option>"+
                        "</select>"+
                    "</td>"+

                    "<td>"+
                        "<select class=\"form-control\" name=\"is_filter\">"+
                        "<option value=\"0\">否</option>"+
                        "<option value=\"1\">是</option>"+
                        "</select>"+
                    "</td>"+

                "</tr>";
            if ("quota-field" === $(th).parent().attr("class").split(' ')[1]){
                $(th).parents(".content-row").find(".quota-config").append(html1);
                $(th).hide()
            }else {
                $(th).parents(".content-row").find(".dimension-config").append(html2);
                var option_eles = $(this).parents(".content-row").find(".dimension-config [name=field_type]").length;
                if($(th).text() === "stat_date"){
                    $($(th).parents(".content-row").find(".dimension-config [name=field_type]")[option_eles-1]).val(2)
                }else {
                    $($(th).parents(".content-row").find(".dimension-config [name=field_type]")[option_eles-1]).val(1)
                }
                $(th).hide()
            }

        }

        // 初始化已经配置好的指标和维度信息
        function init_dimension_and_quota() {
            $.each($("[name=source_name]"), function (i, x) {
                var table_name = $(x).val().split('.')[1];
                var has_exist_field=[];
                $.each($(x).parents(".content-row").find("[name=field_name]"), function (j, y) {
                    has_exist_field.push($(y).val())
                });

                $.ajax({
                    type: "PUT",
                    url: "/visual/report_block_config",
                    data: {"table_name": table_name},
                    dataType: "JSON",
                    success: function (res) {
                        if(res['code']===0 ){
                            var html;
                            $.each(JSON.parse(res['data']), function (key, value) {
                                if($.inArray(key, has_exist_field) < 0){
                                     if (value==="dimension"){
                                        html = "<span class=\"label label-primary\" draggable=\"true\" ondblclick="+"dimension_and_quota_ondbclick(this)"+">"+key+"</span>";
                                        $(x).parents(".content-row").children().find(".dimension-field").append(html)
                                    }else {
                                        html = "<span class=\"label label-primary\" draggable=\"true\" ondblclick="+"dimension_and_quota_ondbclick(this)"+">"+key+"</span>";
                                        $(x).parents(".content-row").children().find(".quota-field").append(html)
                                    }
                                }

                            });
                        }
                    }
                })
            })
        }

        // 数据块的移动
        function move_up(th) {
             if($(th).parents("form").prev().is("form")){
                 var current_ele = $(th).parents("form");
                 var prev_ele = $(th).parents("form").prev();
                 var current_html = $(th).parents("form").html();
                 var prev_html = $(th).parents("form").prev().html();

                 current_ele.html(prev_html);
                 prev_ele.html(current_html);
             }
        }

        function move_down(th) {
            if($(th).parents("form").next().is("form")){
                var current_ele = $(th).parents("form");
                var next_ele = $(th).parents("form").next();
                var current_html = $(th).parents("form").html();
                var next_html = $(th).parents("form").next().html();
                current_ele.html(next_html);
                next_ele.html(current_html);
            }
        }

        function delete_block(th) {
            var current_bid = $(th).parents("form").find("[name=bid]").val();
            if (current_bid){
                $.ajax({
                    type: "DELETE",
                    url: "/visual/report_block_config",
                    data: {'bid': current_bid},
                    dataType: "JSON",
                    success: function (args) {
                        if(args['code']===0){
                            window.location.reload()
                        }else {
                            alert('失败')
                        }
                }
            });
            }else {
                $(th).parents("form").remove()
            }
        }
        // 初始化select选中的值
        function init_select_value() {
            $.each($("select"), function (i, x) {
                // 定义所有的select元素
                var attr_ele = ["chart_type", "report_type", "field_type", "method", "furl_mode", 'is_sort', 'is_filter'];
                // 对单个select下面的option进行遍历，并且赋值
                $.each(attr_ele, function (j, y) {
                    if (y==="chart_type"){
                        if($(x).attr(y)){
                            $($(x).children()[$(x).attr(y)-1]).attr("selected", true);
                            return false
                        }else {
                            return true
                        }
                    }else {
                        if($(x).attr(y)){
                            $($(x).children()[$(x).attr(y)]).attr("selected", true);
                            return false
                        }else {
                            return true
                        }
                    }
                });
            })
        }


    </script>
    
{% endblock %}z